# --- BEST-EFFORT APPLICATIONS (NOISE GENERATORS) ---
# These apps are throttled by the flow manager when critical app jitter increases

# 1. Telemetry Upload (Large bandwidth consumer / NOISE SOURCE)
# This is the primary target for bandwidth throttling
apiVersion: v1
kind: Service
metadata:
  name: telemetry-upload-svc
spec:
  selector:
    app: telemetry-upload
  ports:
  - name: tcp
    protocol: TCP
    port: 5203
    targetPort: 5203
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: telemetry-upload-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: telemetry-upload
  template:
    metadata:
      labels:
        app: telemetry-upload
        priority: best-effort # Flow manager throttles this
      annotations:
        kubernetes.io/egress-bandwidth: "1000M" # Initial bandwidth, controller adjusts this
    spec:
      # Try to schedule away from critical apps
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: priority
                  operator: In
                  values:
                  - critical
              topologyKey: kubernetes.io/hostname
      containers:
      - name: telemetry-client
        image: networkstatic/iperf3
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "Telemetry Upload: Sending heavy data to remote server (simulated)..."
            # Start iperf3 server for external connections
            iperf3 -s -p 5203 -D
            # Also actively send traffic to critical services (competing for bandwidth)
            while true; do
              iperf3 -c robot-control-svc -u -b 150M -t 30 -p 5201 || sleep 5
              sleep 5
            done
        ports:
        - containerPort: 5203
          protocol: TCP

---
# 2. ERP Dashboard (Standard background traffic)
apiVersion: v1
kind: Service
metadata:
  name: erp-dashboard-svc
spec:
  selector:
    app: erp-dashboard
  ports:
  - name: tcp
    protocol: TCP
    port: 5204
    targetPort: 5204
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: erp-dashboard-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: erp-dashboard
  template:
    metadata:
      labels:
        app: erp-dashboard
        priority: best-effort # Flow manager throttles this
      annotations:
        kubernetes.io/egress-bandwidth: "1000M" # Initial bandwidth, controller adjusts this
    spec:
      containers:
      - name: iperf3-server
        image: networkstatic/iperf3
        args: ["-s", "-p", "5204"]
        ports:
        - containerPort: 5204
          protocol: TCP

---
# 3. Noise Generator Client - Creates traffic TO critical services
# This simulates heavy traffic that competes with critical apps
apiVersion: apps/v1
kind: Deployment
metadata:
  name: noise-generator
  labels:
    app: noise-generator
spec:
  replicas: 1  # Active by default to create baseline congestion
  selector:
    matchLabels:
      app: noise-generator
  template:
    metadata:
      labels:
        app: noise-generator
        priority: best-effort
      annotations:
        kubernetes.io/egress-bandwidth: "1000M"  # Controller throttles this
    spec:
      # Force noise generator to different node than critical apps
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: priority
                  operator: In
                  values:
                  - critical
              topologyKey: kubernetes.io/hostname
      containers:
      - name: iperf3-client
        image: networkstatic/iperf3
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "Noise Generator: Creating heavy cross-node traffic..."
            while true; do
              # Send UDP traffic to robot-control (competes with real client)
              iperf3 -c robot-control-svc -u -b 200M -t 30 -p 5201 &
              # Send TCP traffic to safety-scanner (competes with real client)
              iperf3 -c safety-scanner-svc -b 300M -t 30 -p 5202 &
              # Wait for both to complete
              wait
              sleep 5
            done
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "256Mi"
