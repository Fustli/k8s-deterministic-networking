apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: ml-controller-network-security
  namespace: kube-system
spec:
  description: "Network security policy for ML Controller HA pods"
  endpointSelector:
    matchLabels:
      app: ml-controller-ha
  
  # Ingress rules - what can connect TO ml-controller pods
  ingress:
  # Allow Prometheus to scrape metrics
  - fromEndpoints:
    - matchLabels:
        app: prometheus
        component: server
    toPorts:
    - ports:
      - port: "8080"
        protocol: TCP
      rules:
        http:
        - method: "GET"
          path: "/metrics"
        - method: "GET" 
          path: "/health"
        - method: "GET"
          path: "/ready"
        - method: "GET"
          path: "/leader"
  
  # Allow monitoring namespace access for metrics collection
  - fromEntities:
    - cluster
    fromNamespace:
      matchLabels:
        name: monitoring
    toPorts:
    - ports:
      - port: "8080"
        protocol: TCP
  
  # Allow health checks from kubelet
  - fromEntities:
    - host
    toPorts:
    - ports:
      - port: "8080"
        protocol: TCP
      rules:
        http:
        - method: "GET"
          path: "/health"
        - method: "GET"
          path: "/ready"
  
  # Allow inter-pod communication for leader election coordination
  - fromEndpoints:
    - matchLabels:
        app: ml-controller-ha
    toPorts:
    - ports:
      - port: "8080"
        protocol: TCP
  
  # Egress rules - what ml-controller pods can connect TO
  egress:
  # Allow access to Kubernetes API server for leader election and deployment updates
  - toEntities:
    - kube-apiserver
    toPorts:
    - ports:
      - port: "443"
        protocol: TCP
      - port: "6443" 
        protocol: TCP
  
  # Allow access to Prometheus server for metrics collection
  - toEndpoints:
    - matchLabels:
        app: prometheus
        component: server
    toPorts:
    - ports:
      - port: "9090"
        protocol: TCP
      rules:
        http:
        - method: "GET"
          path: "/api/v1/query"
        - method: "POST"
          path: "/api/v1/query"
  
  # Allow access to monitoring namespace for Prometheus
  - toNamespace:
      matchLabels:
        name: monitoring
    toPorts:
    - ports:
      - port: "9090"
        protocol: TCP
  
  # Allow DNS resolution
  - toEndpoints:
    - matchLabels:
        k8s-app: kube-dns
    toPorts:
    - ports:
      - port: "53"
        protocol: UDP
      - port: "53"
        protocol: TCP
  
  # Allow CoreDNS access
  - toEntities:
    - kube-dns
    toPorts:
    - ports:
      - port: "53"
        protocol: UDP
      - port: "53"
        protocol: TCP
  
  # Explicit deny all other traffic (implicit with Cilium default-deny)
  - {}
---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: ml-controller-prometheus-access
  namespace: monitoring
spec:
  description: "Allow Prometheus to access ML Controller metrics"
  endpointSelector:
    matchLabels:
      app: prometheus
      component: server
  
  egress:
  # Allow Prometheus to scrape ML Controller metrics
  - toNamespace:
      matchLabels:
        name: kube-system
    toEndpoints:
    - matchLabels:
        app: ml-controller-ha
    toPorts:
    - ports:
      - port: "8080"
        protocol: TCP
      rules:
        http:
        - method: "GET"
          path: "/metrics"
---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: ml-controller-controlled-deployment-protection
  namespace: default
spec:
  description: "Protect telemetry upload deployment from unauthorized modifications"
  endpointSelector:
    matchLabels:
      app: telemetry-upload
  
  ingress:
  # Allow normal application traffic
  - fromEntities:
    - cluster
    - world
  
  # Bandwidth control annotations can only be modified by ML Controller
  # This is enforced at the Kubernetes RBAC level, not network level
  
  egress:
  # Allow normal application egress with bandwidth controls applied
  - toEntities:
    - world
    - cluster
---
apiVersion: cilium.io/v2
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: ml-controller-cluster-security
spec:
  description: "Cluster-wide security policy for ML Controller system"
  
  # Protect leader election lease from unauthorized access
  endpointSelector:
    matchLabels:
      component: etcd
  
  ingress:
  # Only allow ML Controller instances to access leader election lease
  - fromNamespace:
      matchLabels:
        name: kube-system
    fromEndpoints:
    - matchLabels:
        app: ml-controller-ha
    toPorts:
    - ports:
      - port: "2379"
        protocol: TCP
      - port: "2380" 
        protocol: TCP
  
  # Allow kube-apiserver access to etcd
  - fromEntities:
    - kube-apiserver
    toPorts:
    - ports:
      - port: "2379"
        protocol: TCP
      - port: "2380"
        protocol: TCP