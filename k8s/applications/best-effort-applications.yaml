# --- BEST-EFFORT APPLICATIONS (NOISE GENERATORS) ---
# These apps are throttled by the ML controller when critical app jitter increases

# 1. Telemetry Upload (Large bandwidth consumer / NOISE SOURCE)
# This is the primary target for bandwidth throttling
apiVersion: v1
kind: Service
metadata:
  name: telemetry-upload-svc
spec:
  selector:
    app: telemetry-upload
  ports:
  - name: tcp
    protocol: TCP
    port: 5203
    targetPort: 5203
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: telemetry-upload-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: telemetry-upload
  template:
    metadata:
      labels:
        app: telemetry-upload
        priority: best-effort # ML controller throttles this
      annotations:
        kubernetes.io/egress-bandwidth: "1000M" # Initial bandwidth, controller adjusts this
    spec:
      containers:
      - name: iperf3-server
        image: networkstatic/iperf3
        args: ["-s", "-p", "5203"]
        ports:
        - containerPort: 5203
          protocol: TCP

---
# 2. ERP Dashboard (Standard background traffic)
apiVersion: v1
kind: Service
metadata:
  name: erp-dashboard-svc
spec:
  selector:
    app: erp-dashboard
  ports:
  - name: tcp
    protocol: TCP
    port: 5204
    targetPort: 5204
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: erp-dashboard-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: erp-dashboard
  template:
    metadata:
      labels:
        app: erp-dashboard
        priority: best-effort # ML controller throttles this
      annotations:
        kubernetes.io/egress-bandwidth: "1000M" # Initial bandwidth, controller adjusts this
    spec:
      containers:
      - name: iperf3-server
        image: networkstatic/iperf3
        args: ["-s", "-p", "5204"]
        ports:
        - containerPort: 5204
          protocol: TCP

---
# 3. Noise Generator Client - Creates traffic TO telemetry-upload
# This simulates heavy uploads that cause congestion
apiVersion: apps/v1
kind: Deployment
metadata:
  name: noise-generator
  labels:
    app: noise-generator
spec:
  replicas: 0  # Scale up to inject noise: kubectl scale deployment noise-generator --replicas=1
  selector:
    matchLabels:
      app: noise-generator
  template:
    metadata:
      labels:
        app: noise-generator
        priority: best-effort
    spec:
      containers:
      - name: iperf3-client
        image: networkstatic/iperf3
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "Noise Generator: Creating heavy traffic to telemetry-upload-svc..."
            while true; do
              # High bandwidth to cause congestion (500 Mbps)
              iperf3 -c telemetry-upload-svc -b 500M -t 60 -p 5203 || sleep 5
              sleep 2
            done
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "256Mi"
